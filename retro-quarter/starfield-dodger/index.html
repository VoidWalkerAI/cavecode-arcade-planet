<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Retro Quarter ‚Äî Starfield Dodger (ARC-RQ-002)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <style>
    :root {
      --bg: #020617;
      --panel: #0b1120;
      --border: #1f2937;
      --text-main: #e5e7eb;
      --text-soft: #9ca3af;

      --ship: #38bdf8;
      --ship-outline: #0f172a;
      --asteroid-core: #9ca3af;
      --asteroid-edge: #e5e7eb;
      --star-dim: #111827;
      --star-bright: #f9fafb;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      background: radial-gradient(circle at top, #111827 0, #020617 60%);
      color: var(--text-main);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      user-select: none;
    }

    header {
      margin-top: 0.75rem;
      text-align: center;
    }

    header h1 {
      margin: 0;
      font-size: 1.05rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    header .sub {
      margin-top: 0.15rem;
      font-size: 0.8rem;
      color: var(--text-soft);
    }

    #hud {
      margin-top: 0.5rem;
      font-size: 0.85rem;
      color: var(--text-soft);
      display: flex;
      gap: 0.75rem;
    }

    #game-shell {
      margin-top: 0.6rem;
      padding: 0.8rem 1rem 1rem;
      border-radius: 0.75rem;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
    }

    canvas {
      width: 320px;
      height: 240px;
      max-width: 100vw;
      border-radius: 0.6rem;
      border: 1px solid var(--border);
      background: radial-gradient(circle at top, #020617 0, #020617 60%);
      touch-action: manipulation;
    }

    #controls-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      max-width: 320px;
      font-size: 0.8rem;
      color: var(--text-soft);
      gap: 0.5rem;
    }

    #status {
      flex: 1;
    }

    #startBtn {
      padding: 0.25rem 0.8rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      background: radial-gradient(circle at top, rgba(56, 189, 248, 0.55), rgba(15, 23, 42, 1));
      color: var(--text-main);
      font-size: 0.8rem;
      cursor: pointer;
      white-space: nowrap;
    }

    #startBtn:active {
      transform: translateY(1px);
    }

    @media (max-width: 480px) {
      canvas {
        width: 280px;
        height: 210px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Retro Quarter ‚Äî Starfield Dodger ¬∑ ARC-RQ-002</h1>
    <div class="sub">Glide through the falling stone and survive as long as you can.</div>
  </header>

  <div id="hud">
    <div>Score: <span id="scoreText">0</span></div>
    <div>Best: <span id="bestText">0</span></div>
  </div>

  <div id="game-shell">
    <canvas id="game" width="320" height="240"></canvas>
    <div id="controls-row">
      <div id="status">Tap Start Flight to begin.</div>
      <button id="startBtn">Start Flight</button>
    </div>
  </div>

  <script>
    // ============================================================
    // üéöÔ∏è TUNING (sync with starfield-dodger.cavecode)
    // ============================================================
    const TUNING = {
      shipSpeed: 220,
      baseFallSpeed: 80,
      fallSpeedIncrease: 10,
      spawnIntervalStart: 0.8,
      spawnIntervalMin: 0.25,
      spawnIntervalDecay: 0.04,
      asteroidMinSize: 6,
      asteroidMaxSize: 13
    };

    // ============================================================
    // CANVAS + ELEMENTS
    // ============================================================
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");

    const scoreText = document.getElementById("scoreText");
    const bestText = document.getElementById("bestText");
    const statusEl = document.getElementById("status");
    const startBtn = document.getElementById("startBtn");

    // ============================================================
    // STATE
    // ============================================================
    const ship = {
      x: canvas.width / 2,
      y: canvas.height - 26,
      w: 18,
      h: 18
    };

    let asteroids = []; // {x,y,r}
    let running = false;
    let lastTime = 0;
    let elapsed = 0;
    let score = 0;
    let bestScore = 0;

    let spawnTimer = 0;
    let currentSpawnInterval = TUNING.spawnIntervalStart;
    let leftHeld = false;
    let rightHeld = false;

    // For touch-move hold
    let touchMoveDir = 0; // -1 left, +1 right, 0 none

    // ============================================================
    // HELPERS
    // ============================================================
    function resetGame() {
      asteroids = [];
      elapsed = 0;
      score = 0;
      spawnTimer = 0;
      currentSpawnInterval = TUNING.spawnIntervalStart;
      ship.x = canvas.width / 2;
      statusEl.textContent = "Dodge the asteroids and stay alive.";
      scoreText.textContent = "0";
    }

    function randomRange(min, max) {
      return min + Math.random() * (max - min);
    }

    function spawnAsteroid() {
      const r = randomRange(TUNING.asteroidMinSize, TUNING.asteroidMaxSize);
      const x = randomRange(r, canvas.width - r);
      const y = -r * 2;
      asteroids.push({ x, y, r });
    }

    function circleRectCollide(c, r) {
      // Clamp circle center to rect bounds and check distance
      const closestX = Math.max(r.x, Math.min(c.x, r.x + r.w));
      const closestY = Math.max(r.y, Math.min(c.y, r.y + r.h));
      const dx = c.x - closestX;
      const dy = c.y - closestY;
      return dx * dx + dy * dy <= c.r * c.r;
    }

    function gameOver() {
      running = false;
      if (score > bestScore) {
        bestScore = score;
        bestText.textContent = bestScore;
      }
      statusEl.textContent = "Ship lost in the field. Tap Start to try again.";
    }

    // ============================================================
    // UPDATE
    // ============================================================
    function update(dt) {
      // Movement input
      let moveDir = 0;
      if (leftHeld) moveDir -= 1;
      if (rightHeld) moveDir += 1;
      if (touchMoveDir !== 0) moveDir = touchMoveDir;

      ship.x += moveDir * TUNING.shipSpeed * dt;
      if (ship.x < ship.w / 2) ship.x = ship.w / 2;
      if (ship.x > canvas.width - ship.w / 2) ship.x = canvas.width - ship.w / 2;

      // Difficulty scaling
      const fallSpeed = TUNING.baseFallSpeed + TUNING.fallSpeedIncrease * elapsed;

      currentSpawnInterval -= TUNING.spawnIntervalDecay * dt;
      if (currentSpawnInterval < TUNING.spawnIntervalMin) {
        currentSpawnInterval = TUNING.spawnIntervalMin;
      }

      // Asteroids
      spawnTimer += dt;
      if (spawnTimer >= currentSpawnInterval) {
        spawnAsteroid();
        spawnTimer = 0;
      }

      asteroids.forEach(a => {
        a.y += fallSpeed * dt;
      });

      asteroids = asteroids.filter(a => a.y - a.r < canvas.height + 20);

      // Collision
      const shipRect = {
        x: ship.x - ship.w / 2,
        y: ship.y - ship.h / 2,
        w: ship.w,
        h: ship.h
      };

      for (const a of asteroids) {
        const c = { x: a.x, y: a.y, r: a.r };
        if (circleRectCollide(c, shipRect)) {
          gameOver();
          return;
        }
      }

      // Score
      score = Math.floor(elapsed * 10); // tenths
      scoreText.textContent = score;
    }

    // ============================================================
    // RENDER
    // ============================================================
    function render() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Starfield background
      const g = ctx.createLinearGradient(0, 0, 0, canvas.height);
      g.addColorStop(0, "#020617");
      g.addColorStop(1, "#020617");
      ctx.fillStyle = g;
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Soft star dots
      ctx.fillStyle = "#111827";
      for (let i = 0; i < 35; i++) {
        const x = (i * 37) % canvas.width;
        const y = (i * 53) % canvas.height;
        ctx.fillRect(x, y, 1, 1);
      }

      ctx.fillStyle = "#f9fafb";
      for (let i = 0; i < 18; i++) {
        const x = (i * 19 + 23) % canvas.width;
        const y = (i * 29 + 41) % canvas.height;
        ctx.fillRect(x, y, 1, 1);
      }

      // Asteroids
      asteroids.forEach(a => {
        const gradient = ctx.createRadialGradient(
          a.x - a.r * 0.3, a.y - a.r * 0.3, a.r * 0.2,
          a.x, a.y, a.r
        );
        gradient.addColorStop(0, "#f9fafb");
        gradient.addColorStop(1, "#9ca3af");
        ctx.fillStyle = gradient;
        ctx.beginPath();
        ctx.arc(a.x, a.y, a.r, 0, Math.PI * 2);
        ctx.fill();
      });

      // Ship (simple triangle)
      const sx = ship.x;
      const sy = ship.y;
      const w = ship.w;
      const h = ship.h;

      ctx.fillStyle = "#38bdf8";
      ctx.strokeStyle = "#0f172a";
      ctx.lineWidth = 2;

      ctx.beginPath();
      ctx.moveTo(sx, sy - h / 2);          // tip
      ctx.lineTo(sx - w / 2, sy + h / 2);  // left
      ctx.lineTo(sx + w / 2, sy + h / 2);  // right
      ctx.closePath();
      ctx.fill();
      ctx.stroke();

      // Little thruster
      ctx.beginPath();
      ctx.moveTo(sx - w / 4, sy + h / 2);
      ctx.lineTo(sx + w / 4, sy + h / 2);
      ctx.lineTo(sx, sy + h / 2 + 5);
      ctx.closePath();
      ctx.fillStyle = "#fb923c";
      ctx.fill();
    }

    // ============================================================
    // MAIN LOOP
    // ============================================================
    function loop(timestamp) {
      if (!running) return;
      if (!lastTime) lastTime = timestamp;
      const dt = (timestamp - lastTime) / 1000;
      lastTime = timestamp;
      elapsed += dt;

      update(dt);
      render();

      if (running) {
        requestAnimationFrame(loop);
      }
    }

    // ============================================================
    // EVENTS
    // ============================================================
    startBtn.addEventListener("click", () => {
      running = true;
      lastTime = 0;
      resetGame();
      requestAnimationFrame(loop);
    });

    document.addEventListener("keydown", e => {
      if (e.key === "ArrowLeft" || e.key === "a" || e.key === "A") leftHeld = true;
      if (e.key === "ArrowRight" || e.key === "d" || e.key === "D") rightHeld = true;
    });

    document.addEventListener("keyup", e => {
      if (e.key === "ArrowLeft" || e.key === "a" || e.key === "A") leftHeld = false;
      if (e.key === "ArrowRight" || e.key === "d" || e.key === "D") rightHeld = false;
    });

    canvas.addEventListener("touchstart", e => {
      e.preventDefault();
      const rect = canvas.getBoundingClientRect();
      const x = e.touches[0].clientX - rect.left;
      touchMoveDir = x < rect.width / 2 ? -1 : 1;
    }, { passive: false });

    canvas.addEventListener("touchend", () => {
      touchMoveDir = 0;
    });

    canvas.addEventListener("mousedown", e => {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      touchMoveDir = x < rect.width / 2 ? -1 : 1;
    });

    window.addEventListener("mouseup", () => {
      touchMoveDir = 0;
    });

    // Initial static render
    render();
  </script>
</body>
</html>
