<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mind Chambers — Focus Relay · ARC-MC-002</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!--
    BLOCK 1 — SHELL & BRAND (LOCKED)
    CaveCode Arcade Planet · Mind-Chambers Line
  -->
  <style>
    :root {
      --cc-bg: #020617;
      --cc-panel: #02081b;
      --cc-panel-soft: #0b1120;
      --cc-border: #1f2937;
      --cc-accent: #38bdf8;
      --cc-accent-soft: #bae6fd;
      --cc-text-main: #e5e7eb;
      --cc-text-soft: #9ca3af;
      --cc-badge-bg: #0b1120;
      --node-radius: 999px;
      --node-gap: 0.4rem;
      --node-size: min(18vw, 4.4rem);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at top, #111827 0, #020617 55%);
      color: var(--cc-text-main);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      display: flex;
      justify-content: center;
      padding: 1.5rem 0.75rem 2.5rem;
    }

    #shell {
      width: 100%;
      max-width: 960px;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    header {
      background: linear-gradient(135deg, #020617, #030712);
      border-radius: 999px;
      border: 1px solid #1f2937;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.65);
      padding: 0.9rem 1.6rem;
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }

    @media (min-width: 640px) {
      header {
        flex-direction: row;
        align-items: baseline;
        justify-content: space-between;
      }
    }

    .title-line {
      font-size: clamp(1rem, 2.2vw, 1.15rem);
      font-weight: 700;
      letter-spacing: 0.07em;
    }

    .subtitle-line {
      font-size: 0.79rem;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: var(--cc-text-soft);
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
    }

    .subtitle-pill {
      padding: 0.11rem 0.55rem;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: rgba(15, 23, 42, 0.75);
      font-size: 0.68rem;
    }

    .subtitle-pill.level-pill {
      border-color: rgba(59, 130, 246, 0.95);
      background: radial-gradient(circle at top left, #0f172a 0, #020617 65%);
      color: #bfdbfe;
      font-weight: 600;
    }

    main {
      display: flex;
      justify-content: center;
    }

    #panel {
      width: 100%;
      max-width: 960px;
      background: radial-gradient(circle at top, #020617 0, #000000 95%);
      border-radius: 1.5rem;
      border: 1px solid rgba(15, 23, 42, 0.9);
      box-shadow:
        0 20px 40px rgba(0, 0, 0, 0.85),
        0 0 0 1px rgba(15, 23, 42, 0.7);
      padding: 1.3rem 1.2rem 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.9rem;
    }

    @media (min-width: 720px) {
      #panel {
        padding: 1.4rem 1.6rem 1.8rem;
      }
    }

    #tag-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      font-size: 0.72rem;
    }

    .tag {
      padding: 0.15rem 0.6rem;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: var(--cc-badge-bg);
      color: var(--cc-text-soft);
      text-transform: uppercase;
      letter-spacing: 0.14em;
      white-space: nowrap;
    }

    .tag.primary {
      border-color: rgba(59, 130, 246, 0.96);
      color: var(--cc-accent-soft);
    }

    #prompt {
      font-size: 0.8rem;
      color: var(--cc-text-soft);
      line-height: 1.5;
    }

    #status-row {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 0.4rem;
      font-size: 0.78rem;
      margin-top: 0.1rem;
    }

    .stat-card {
      border-radius: 0.7rem;
      background: radial-gradient(circle at top, #020617 0, #020617 70%);
      border: 1px solid #111827;
      padding: 0.45rem 0.55rem 0.4rem;
      display: flex;
      flex-direction: column;
      gap: 0.12rem;
    }

    .stat-label {
      text-transform: uppercase;
      letter-spacing: 0.16em;
      font-size: 0.6rem;
      color: var(--cc-text-soft);
    }

    .stat-value {
      font-size: 0.9rem;
      font-weight: 600;
    }

    .stat-value.good {
      color: #bbf7d0;
    }

    .stat-value.bad {
      color: #fecaca;
    }

    #board-shell {
      margin-top: 0.4rem;
      padding: 0.9rem 0.9rem 0.95rem;
      border-radius: 1.2rem;
      border: 1px solid #111827;
      background: radial-gradient(circle at top, #020617 0, #020617 70%);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.7rem;
    }

    #board-grid {
      display: grid;
      grid-template-columns: repeat(3, var(--node-size));
      grid-template-rows: repeat(3, var(--node-size));
      gap: var(--node-gap);
      touch-action: manipulation;
    }

    .node {
      width: var(--node-size);
      height: var(--node-size);
      border-radius: var(--node-radius);
      background: #020617;
      border: 1px solid #1f2937;
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 0.9),
        0 8px 14px rgba(0, 0, 0, 0.65);
      cursor: pointer;
      user-select: none;
      position: relative;
      overflow: hidden;
      transition:
        transform 0.12s ease-out,
        box-shadow 0.12s ease-out,
        background 0.12s ease-out,
        filter 0.12s ease-out;
      font-size: 1.3rem;
      font-weight: 700;
      color: #e5e7eb;
    }

    .node-inner {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .node.idle {
      background: radial-gradient(circle at top, #020617 0, #020617 70%);
    }

    .node.reveal {
      background: radial-gradient(circle at top, #1d4ed8 0, #0f172a 75%);
      filter: brightness(1.15);
    }

    .node.correct {
      background: radial-gradient(circle at top, #16a34a 0, #052e16 75%);
    }

    .node.wrong {
      background: radial-gradient(circle at top, #b91c1c 0, #450a0a 75%);
    }

    .node:hover {
      filter: brightness(1.09);
    }

    #board-footer {
      font-size: 0.78rem;
      color: var(--cc-text-soft);
      text-align: center;
      max-width: 480px;
    }

    #buttons-row {
      display: flex;
      justify-content: center;
      margin-top: 0.4rem;
    }

    button.cc-btn {
      background: radial-gradient(circle at top, #020617 0, #020617 70%);
      border-radius: 999px;
      border: 1px solid #1f2937;
      padding: 0.45rem 1.1rem;
      font-size: 0.76rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--cc-text-main);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.6);
      transition:
        background 0.12s ease-out,
        transform 0.12s ease-out,
        box-shadow 0.12s ease-out;
    }

    button.cc-btn:hover {
      background: radial-gradient(circle at top, #030712 0, #020617 70%);
      transform: translateY(-1px);
      box-shadow: 0 14px 26px rgba(0, 0, 0, 0.75);
    }

    button.cc-btn:active {
      transform: translateY(1px);
      box-shadow: 0 7px 16px rgba(0, 0, 0, 0.65);
    }

    button.cc-btn span.icon {
      font-size: 0.85rem;
    }

    footer {
      margin-top: 0.5rem;
      font-size: 0.72rem;
      color: var(--cc-text-soft);
      text-align: center;
    }

    /* Modal */

    #modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.88);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
      padding: 1.2rem;
    }

    #modal-backdrop.show {
      display: flex;
    }

    #modal-panel {
      width: 100%;
      max-width: 360px;
      border-radius: 1.4rem;
      background: radial-gradient(circle at top, #020617 0, #000000 80%);
      border: 1px solid rgba(248, 250, 252, 0.05);
      box-shadow:
        0 24px 70px rgba(0, 0, 0, 0.9),
        0 0 0 1px rgba(59, 130, 246, 0.45);
      padding: 1.1rem 1.2rem 1.25rem;
      display: flex;
      flex-direction: column;
      gap: 0.7rem;
    }

    #modal-title {
      font-size: 1.02rem;
      font-weight: 700;
    }

    #modal-body {
      font-size: 0.82rem;
      color: var(--cc-text-soft);
      line-height: 1.5;
    }

    #modal-actions {
      margin-top: 0.4rem;
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
    }

    .pill {
      padding: 0.16rem 0.5rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--cc-text-soft);
    }

    .pill.good {
      border-color: rgba(52, 211, 153, 0.9);
      color: #bbf7d0;
    }

    .pill.bad {
      border-color: rgba(248, 113, 113, 0.9);
      color: #fecaca;
    }

    @media (max-width: 720px) {
      #status-row {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 0 0.35rem;
      }
      #panel {
        padding-inline: 1rem;
      }
    }
  </style>
</head>
<body>
  <div id="shell">
    <header>
      <div>
        <div class="title-line">
          MIND CHAMBERS &mdash; FOCUS RELAY &middot; ARC-MC-002
        </div>
        <div class="subtitle-line">
          <span class="subtitle-pill">CaveCode Arcade Planet</span>
          <span class="subtitle-pill">Mind-Chambers Line</span>
          <span class="subtitle-pill">Memory Grid</span>
        </div>
      </div>
      <div class="subtitle-line">
        <span class="subtitle-pill level-pill" id="header-level-pill">
          LEVEL 1
        </span>
      </div>
    </header>

    <main>
      <section id="panel">
        <div id="tag-row">
          <span class="tag primary">Focus Track</span>
          <span class="tag">3×3 Board</span>
          <span class="tag">Pattern Growth</span>
          <span class="tag">Time Pressure</span>
          <span class="tag">Single-File Engine</span>
          <span class="tag">CaveCode v1 Blocks</span>
        </div>

        <div id="prompt">
          Watch the numbers flash on the grid. When they vanish, tap the nodes back
          in order: 1, 2, 3… Clear enough rounds to climb the Focus tiers.
        </div>

        <div id="status-row">
          <div class="stat-card">
            <div class="stat-label">Tier</div>
            <div class="stat-value" id="tier-display">1</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Round</div>
            <div class="stat-value" id="round-display">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Best Streak</div>
            <div class="stat-value" id="best-display">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Pattern Size</div>
            <div class="stat-value" id="pattern-display">3</div>
          </div>
        </div>

        <div id="status-row" style="margin-top:0.2rem;">
          <div class="stat-card">
            <div class="stat-label">Reveal Time</div>
            <div class="stat-value" id="reveal-display">1.6s</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Chain Depth</div>
            <div class="stat-value" id="chain-display">x1.0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Last Miss</div>
            <div class="stat-value bad" id="last-miss-display">—</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">State</div>
            <div class="stat-value" id="state-display">Idle</div>
          </div>
        </div>

        <div id="board-shell">
          <div id="board-grid" aria-label="Focus grid"></div>
          <div id="board-footer">
            Higher tiers mean longer patterns and shorter reveal windows. When you fail,
            the full correct path reappears so you can see what your mind dropped.
          </div>
        </div>

        <div id="buttons-row">
          <button class="cc-btn" id="restart-btn" type="button">
            <span class="icon">↻</span>
            <span>Restart Run</span>
          </button>
        </div>
      </section>
    </main>

    <footer>
      Forged in CaveCode Arcade Planet · SageWire Syndicate
    </footer>
  </div>

  <!-- Small run summary modal -->
  <div id="modal-backdrop" aria-hidden="true">
    <div id="modal-panel">
      <div id="modal-title">Run Complete</div>
      <div id="modal-body">
        Your focus run has ended. Want to try again and push for a deeper tier?
      </div>
      <div id="modal-actions">
        <button class="cc-btn" id="modal-secondary" type="button">
          <span>Close</span>
        </button>
        <button class="cc-btn" id="modal-primary" type="button">
          <span class="icon">↻</span>
          <span>Restart Run</span>
        </button>
      </div>
    </div>
  </div>

  <!--
    BLOCK 2 — CORE LOOP SUMMARY (READABLE MAP)

    - Board is always 3×3.
    - Game picks a pattern of nodes and labels them 1..N.
    - REVEAL:
        * All nodes in the pattern show their numbers for a short time.
    - INPUT:
        * Player taps nodes in ascending order (1, 2, 3...).
        * Correct tap → node flashes green, advance expected index.
        * Wrong tap → node flashes red, run ends; re-show full correct pattern.
    - After a completed round:
        * Pattern grows by +1 node.
        * Reveal time shrinks a bit (down to a floor).
        * Round counter increments, Tier may increase.
    - Run ends:
        * On first wrong tap.
        * Modal shows your round + tier; restart puts you back at Tier 1.
  -->

  <script>
    // BLOCK 3 — LEVEL TRACK & RULES (GAME TUNING)

    const FOCUS_TUNING = {
      gridSize: 3,              // 3×3
      startPatternLength: 3,    // first pattern size
      patternIncrement: 1,      // +1 per completed round
      revealTimeMs: 1600,       // starting reveal window (ms)
      minRevealTimeMs: 700,     // shortest reveal window
      revealTimeDecayMs: 100,   // shrink per completed round (ms)
      chainStep: 0.25           // just for display: “depth” of correct streaks
    };

    function patternLengthToTier(len) {
      if (len <= 4) return 1;
      if (len <= 6) return 2;
      if (len <= 8) return 3;
      if (len <= 10) return 4;
      return 5;
    }

    // BLOCK 4 — ENGINE & BOARD (GAME LOGIC)

    const boardEl = document.getElementById("board-grid");
    const tierDisplay = document.getElementById("tier-display");
    const roundDisplay = document.getElementById("round-display");
    const bestDisplay = document.getElementById("best-display");
    const patternDisplay = document.getElementById("pattern-display");
    const revealDisplay = document.getElementById("reveal-display");
    const chainDisplay = document.getElementById("chain-display");
    const lastMissDisplay = document.getElementById("last-miss-display");
    const stateDisplay = document.getElementById("state-display");
    const headerLevelPill = document.getElementById("header-level-pill");

    const restartBtn = document.getElementById("restart-btn");
    const modalBackdrop = document.getElementById("modal-backdrop");
    const modalTitle = document.getElementById("modal-title");
    const modalBody = document.getElementById("modal-body");
    const modalPrimary = document.getElementById("modal-primary");
    const modalSecondary = document.getElementById("modal-secondary");

    const STATE = {
      IDLE: "Idle",
      REVEAL: "Reveal",
      INPUT: "Input",
      GAME_OVER: "Game Over",
    };

    let currentState = STATE.IDLE;

    let nodes = [];          // { el, inner }
    let pattern = [];        // array of node indexes 0..8
    let patternLength = FOCUS_TUNING.startPatternLength;
    let revealTimeMs = FOCUS_TUNING.revealTimeMs;
    let expectedIndex = 1;   // what number we’re waiting for
    let chainDepth = 0;
    let roundsCompleted = 0;
    let bestRounds = 0;
    let lastMiss = "—";
    let revealTimeoutId = null;

    // Web Audio
    let audioCtx = null;

    function ensureAudio() {
      if (!audioCtx) {
        const AC = window.AudioContext || window.webkitAudioContext;
        if (AC) audioCtx = new AC();
      }
    }

    function playTone(freq, duration = 0.14, type = "sine", gain = 0.2) {
      if (!audioCtx) return;
      const ctx = audioCtx;
      const osc = ctx.createOscillator();
      const g = ctx.createGain();

      osc.type = type;
      osc.frequency.value = freq;
      g.gain.value = gain;
      osc.connect(g);
      g.connect(ctx.destination);

      const now = ctx.currentTime;
      osc.start(now);
      g.gain.exponentialRampToValueAtTime(0.001, now + duration);
      osc.stop(now + duration);
    }

    function playRevealChime() {
      playTone(660, 0.13, "sine", 0.22);
    }

    function playCorrectBlip() {
      playTone(880, 0.09, "triangle", 0.22);
    }

    function playFailSting() {
      playTone(280, 0.16, "sawtooth", 0.22);
      setTimeout(() => playTone(180, 0.14, "sawtooth", 0.22), 120);
    }

    function playRestartChime() {
      playTone(520, 0.11, "square", 0.18);
    }

    function setState(next, note) {
      currentState = next;
      stateDisplay.textContent = next;
      if (note) {
        modalBody.dataset.note = note;
      }
    }

    function buildBoard() {
      boardEl.innerHTML = "";
      nodes = [];

      const total = FOCUS_TUNING.gridSize * FOCUS_TUNING.gridSize;

      for (let i = 0; i < total; i++) {
        const node = document.createElement("button");
        node.className = "node idle";
        node.type = "button";
        node.dataset.index = String(i);

        const inner = document.createElement("div");
        inner.className = "node-inner";
        inner.textContent = "";
        node.appendChild(inner);

        node.addEventListener("click", () => onNodeClick(i));

        boardEl.appendChild(node);
        nodes.push({ el: node, inner });
      }
    }

    function clearNodeStyles() {
      nodes.forEach(n => {
        n.el.classList.remove("reveal", "correct", "wrong");
        n.el.classList.add("idle");
        n.inner.textContent = "";
      });
    }

    function generatePattern() {
      const total = nodes.length;
      const indices = Array.from({ length: total }, (_, i) => i);

      // Fisher–Yates shuffle
      for (let i = indices.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [indices[i], indices[j]] = [indices[j], indices[i]];
      }

      pattern = indices.slice(0, patternLength);
    }

    function updateHud() {
      const tier = patternLengthToTier(patternLength);
      tierDisplay.textContent = String(tier);
      headerLevelPill.textContent = "TIER " + tier;

      roundDisplay.textContent = String(roundsCompleted);
      bestDisplay.textContent = String(bestRounds);

      patternDisplay.textContent = String(patternLength);
      revealDisplay.textContent = (revealTimeMs / 1000).toFixed(1) + "s";

      const mult = 1 + chainDepth * FOCUS_TUNING.chainStep;
      chainDisplay.textContent = "x" + mult.toFixed(1);

      lastMissDisplay.textContent = lastMiss;
    }

    function revealPattern() {
      setState(STATE.REVEAL);
      chainDepth = 0;
      expectedIndex = 1;
      clearNodeStyles();
      updateHud();
      playRevealChime();

      pattern.forEach((nodeIndex, i) => {
        const n = nodes[nodeIndex];
        n.el.classList.remove("idle");
        n.el.classList.add("reveal");
        n.inner.textContent = String(i + 1);
      });

      if (revealTimeoutId) {
        clearTimeout(revealTimeoutId);
      }

      revealTimeoutId = setTimeout(() => {
        clearNodeStyles();
        setState(STATE.INPUT);
      }, revealTimeMs);
    }

    function startRun() {
      if (revealTimeoutId) {
        clearTimeout(revealTimeoutId);
        revealTimeoutId = null;
      }

      roundsCompleted = 0;
      patternLength = FOCUS_TUNING.startPatternLength;
      revealTimeMs = FOCUS_TUNING.revealTimeMs;
      lastMiss = "—";
      chainDepth = 0;

      generatePattern();
      updateHud();
      revealPattern();
    }

    function nextRound() {
      roundsCompleted++;
      if (roundsCompleted > bestRounds) {
        bestRounds = roundsCompleted;
      }

      patternLength += FOCUS_TUNING.patternIncrement;
      revealTimeMs = Math.max(
        FOCUS_TUNING.minRevealTimeMs,
        revealTimeMs - FOCUS_TUNING.revealTimeDecayMs
      );

      generatePattern();
      updateHud();

      setTimeout(() => {
        if (currentState !== STATE.GAME_OVER) {
          revealPattern();
        }
      }, 650);
    }

    function showCorrectPattern() {
      pattern.forEach((nodeIndex, i) => {
        const n = nodes[nodeIndex];
        if (!n.el.classList.contains("wrong")) {
          n.el.classList.remove("idle");
          n.el.classList.add("reveal");
          n.inner.textContent = String(i + 1);
        }
      });
    }

    function handleCorrectTap(nodeIndex) {
      const n = nodes[nodeIndex];
      n.el.classList.remove("idle");
      n.el.classList.add("correct");
      playCorrectBlip();

      chainDepth++;
      updateHud();

      expectedIndex++;

      if (expectedIndex > patternLength) {
        // full pattern cleared
        nextRound();
      }
    }

    function handleWrongTap(nodeIndex) {
      const n = nodes[nodeIndex];
      n.el.classList.remove("idle");
      n.el.classList.add("wrong");
      playFailSting();

      lastMiss = "Step " + expectedIndex;
      updateHud();

      setState(STATE.GAME_OVER);
      showCorrectPattern();
      openRunModal();
    }

    function onNodeClick(idx) {
      if (currentState !== STATE.INPUT) return;

      ensureAudio();

      const expectedNodeIndex = pattern[expectedIndex - 1];
      if (idx === expectedNodeIndex) {
        handleCorrectTap(idx);
      } else {
        handleWrongTap(idx);
      }
    }

    function openRunModal() {
      modalTitle.textContent = "Run Complete";
      modalBody.innerHTML =
        "You reached Round <strong>" +
        roundsCompleted +
        "</strong> at Tier <strong>" +
        patternLengthToTier(patternLength) +
        "</strong>.<br/>" +
        "Restart and see if you can push deeper into the chambers.";
      modalBackdrop.classList.add("show");
      modalBackdrop.setAttribute("aria-hidden", "false");
    }

    function closeRunModal() {
      modalBackdrop.classList.remove("show");
      modalBackdrop.setAttribute("aria-hidden", "true");
    }

    // BLOCK 5 — BOOTSTRAP & EVENT WIRING

    boardEl.addEventListener("click", (evt) => {
      const node = evt.target.closest(".node");
      if (!node) return;
      const idx = Number(node.dataset.index);
      onNodeClick(idx);
    });

    restartBtn.addEventListener("click", () => {
      ensureAudio();
      playRestartChime();
      setState(STATE.IDLE);
      closeRunModal();
      startRun();
    });

    modalPrimary.addEventListener("click", () => {
      ensureAudio();
      playRestartChime();
      closeRunModal();
      setState(STATE.IDLE);
      startRun();
    });

    modalSecondary.addEventListener("click", () => {
      ensureAudio();
      closeRunModal();
    });

    modalBackdrop.addEventListener("click", (evt) => {
      if (evt.target === modalBackdrop) {
        closeRunModal();
      }
    });

    // Kick off
    buildBoard();
    updateHud();
  </script>
</body>
</html>
