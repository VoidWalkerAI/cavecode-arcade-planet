<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Scarlet Crush — Lane Stacker · ARC-SC-001</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!--
    BLOCK 1 — SHELL & BRAND (LOCKED)
    CaveCode Arcade Planet · Scarlet-Crush Line
  -->

  <style>
    :root {
      --cc-bg: #020617;
      --cc-panel: #02081b;
      --cc-panel-soft: #0b1120;
      --cc-border: #1f2937;
      --cc-accent: #fb7185;
      --cc-accent-soft: #fda4af;
      --cc-text-main: #e5e7eb;
      --cc-text-soft: #9ca3af;

      --tile-size: min(7vw, 2.6rem);
      --tile-radius: 0.45rem;
      --tile-gap: 0.22rem;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at top, #111827 0, #020617 60%);
      color: var(--cc-text-main);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1.25rem 0.75rem 2.5rem;
    }

    header {
      width: 100%;
      max-width: 960px;
      background: linear-gradient(135deg, #020617, #031525);
      border-radius: 999px;
      border: 1px solid var(--cc-border);
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.7);
      padding: 0.9rem 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }

    @media (min-width: 640px) {
      header {
        flex-direction: row;
        align-items: baseline;
        justify-content: space-between;
      }
    }

    .title-line {
      font-size: clamp(1rem, 2.2vw, 1.15rem);
      font-weight: 700;
      letter-spacing: 0.08em;
    }

    .title-line span.code {
      color: var(--cc-accent-soft);
    }

    .subtitle-line {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--cc-text-soft);
      display: flex;
      flex-wrap: wrap;
      gap: 0.45rem;
    }

    .subtitle-pill {
      padding: 0.1rem 0.6rem;
      border-radius: 999px;
      border: 1px solid #111827;
      background: radial-gradient(circle at top, #0f172a, #020617);
    }

    main {
      width: 100%;
      max-width: 960px;
      margin-top: 1.15rem;
    }

    .panel {
      background: radial-gradient(circle at top left, #020617, #020320 55%);
      border-radius: 1.4rem;
      border: 1px solid var(--cc-border);
      box-shadow: 0 24px 55px rgba(15, 23, 42, 0.95);
      padding: 1.3rem 1.1rem 1.6rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    @media (min-width: 720px) {
      .panel {
        padding: 1.5rem 1.6rem 1.9rem;
      }
    }

    .tag-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
    }

    .tag {
      padding: 0.12rem 0.7rem;
      border-radius: 999px;
      border: 1px solid #111827;
      background: linear-gradient(135deg, #020617, #02081b);
      color: var(--cc-text-soft);
    }

    .tag.highlight {
      border-color: var(--cc-accent-soft);
      color: var(--cc-accent-soft);
    }

    .level-blurb {
      font-size: 0.85rem;
      color: var(--cc-text-soft);
      line-height: 1.35;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 0.55rem;
      font-size: 0.78rem;
    }

    @media (min-width: 720px) {
      .stats-grid {
        grid-template-columns: repeat(6, minmax(0, 1fr));
      }
    }

    .stat-card {
      border-radius: 0.9rem;
      border: 1px solid #101827;
      background: radial-gradient(circle at top, #020617, #02071a 70%);
      padding: 0.35rem 0.55rem;
      display: flex;
      flex-direction: column;
      gap: 0.16rem;
    }

    .stat-label {
      text-transform: uppercase;
      letter-spacing: 0.16em;
      font-size: 0.64rem;
      color: var(--cc-text-soft);
    }

    .stat-value {
      font-size: 0.98rem;
      font-weight: 600;
    }

    .board-shell {
      margin-top: 0.2rem;
      border-radius: 1.2rem;
      border: 1px solid #111827;
      background: radial-gradient(circle at top, #020617, #02081b 60%);
      padding: 0.9rem 0.8rem 0.95rem;
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
    }

    .board-header-line {
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
    }

    .board-title {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: var(--cc-text-soft);
    }

    .board-subtitle {
      font-size: 0.76rem;
      color: var(--cc-text-soft);
    }

    .board-meta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      align-items: center;
      justify-content: space-between;
      font-size: 0.75rem;
      color: var(--cc-text-soft);
    }

    .preview-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.16rem 0.6rem;
      border-radius: 999px;
      border: 1px solid #101827;
      background: #020617;
    }

    .preview-label {
      text-transform: uppercase;
      letter-spacing: 0.16em;
      font-size: 0.6rem;
    }

    .preview-cell {
      width: 1.4rem;
      height: 1.4rem;
      border-radius: 0.45rem;
      background: #020617;
      border: 1px dashed #1f2937;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .tile.preview-tile {
      width: 100%;
      height: 100%;
      border-radius: inherit;
    }

    .board {
      margin-top: 0.1rem;
      display: grid;
      justify-content: center;
      grid-template-columns: repeat(7, var(--tile-size));
      grid-auto-rows: var(--tile-size);
      gap: var(--tile-gap);
      padding: 0.6rem 0.2rem 0.4rem;
      border-radius: 1rem;
      background: radial-gradient(circle at top, #020617, #02081b 70%);
      border: 1px solid #0f172a;
      box-shadow: inset 0 0 20px rgba(15, 23, 42, 0.8);
    }

    .tile {
      width: var(--tile-size);
      height: var(--tile-size);
      border-radius: var(--tile-radius);
      background: #020617;
      border: 1px solid #020617;
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.8);
      position: relative;
      overflow: hidden;
      transition: transform 0.14s ease-out, box-shadow 0.14s ease-out,
        border-color 0.14s ease-out;
    }

    .tile.empty {
      border-color: #020617;
      box-shadow: inset 0 0 0 1px #020617;
      opacity: 0.16;
    }

    .tile.color-0 {
      background: #fb7185;
    }
    .tile.color-1 {
      background: #22c55e;
    }
    .tile.color-2 {
      background: #3b82f6;
    }
    .tile.color-3 {
      background: #facc15;
      color: #1f2937;
    }
    .tile.color-4 {
      background: #a855f7;
    }

    .tile.type-row::after,
    .tile.type-bomb::after {
      content: "";
      position: absolute;
      inset: 18%;
      border-radius: inherit;
      border: 2px solid rgba(15, 23, 42, 0.5);
      box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.5);
    }

    .tile.type-row::before {
      content: "";
      position: absolute;
      left: 17%;
      right: 17%;
      top: 50%;
      height: 2px;
      transform: translateY(-50%);
      background: rgba(15, 23, 42, 0.7);
      box-shadow: 0 -4px 0 rgba(15, 23, 42, 0.6),
        0 4px 0 rgba(15, 23, 42, 0.6);
    }

    .tile.type-bomb::before {
      content: "";
      position: absolute;
      inset: 30%;
      border-radius: inherit;
      border: 2px solid rgba(15, 23, 42, 0.9);
      box-shadow: 0 0 0 2px rgba(15, 23, 42, 0.6);
    }

    .tile.clearing {
      animation: tilePop 0.18s ease-out forwards;
    }

    @keyframes tilePop {
      0% {
        transform: scale(1);
        box-shadow: 0 4px 10px rgba(15, 23, 42, 0.9);
      }
      60% {
        transform: scale(1.1);
        box-shadow: 0 10px 24px rgba(15, 23, 42, 0.7);
      }
      100% {
        transform: scale(0.1);
        opacity: 0;
        box-shadow: 0 0 0 rgba(0, 0, 0, 0);
      }
    }

    .lane-row {
      margin-top: 0.4rem;
      display: flex;
      flex-wrap: nowrap;
      justify-content: center;
      gap: 0.4rem;
    }

    .lane-btn {
      min-width: 2.1rem;
      padding: 0.26rem 0.6rem;
      border-radius: 999px;
      border: 1px solid #111827;
      background: radial-gradient(circle at top, #020617, #071427 70%);
      color: var(--cc-text-main);
      font-size: 0.75rem;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 18px rgba(15, 23, 42, 0.85);
      transition: transform 0.1s ease-out, box-shadow 0.1s ease-out,
        border-color 0.1s ease-out, background 0.1s ease-out;
    }

    .lane-btn:hover {
      border-color: var(--cc-accent-soft);
      background: radial-gradient(circle at top, #020617, #0b1120 70%);
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.95);
    }

    .lane-btn:active {
      transform: translateY(0);
      box-shadow: 0 3px 10px rgba(15, 23, 42, 0.8);
    }

    .board-footer {
      font-size: 0.75rem;
      color: var(--cc-text-soft);
      margin-top: 0.35rem;
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
    }

    .board-footer strong {
      color: var(--cc-accent-soft);
    }

    .controls-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: space-between;
      margin-top: 0.3rem;
    }

    .btn-secondary,
    .btn-primary {
      border-radius: 999px;
      padding: 0.36rem 0.9rem;
      font-size: 0.75rem;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.35rem;
      border: 1px solid #111827;
      background: radial-gradient(circle at top, #020617, #071427 70%);
      color: var(--cc-text-main);
      box-shadow: 0 8px 22px rgba(15, 23, 42, 0.9);
      transition: transform 0.1s ease-out, box-shadow 0.1s ease-out,
        border-color 0.1s ease-out, background 0.1s ease-out;
    }

    .btn-secondary:hover,
    .btn-primary:hover {
      border-color: var(--cc-accent-soft);
      background: radial-gradient(circle at top, #020617, #0b1120 75%);
      transform: translateY(-1px);
      box-shadow: 0 10px 26px rgba(15, 23, 42, 0.95);
    }

    .btn-secondary:active,
    .btn-primary:active {
      transform: translateY(0);
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.9);
    }

    .btn-primary {
      border-color: var(--cc-accent);
      background: radial-gradient(circle at top, #fb7185, #be123c 90%);
      color: #0b1120;
    }

    .btn-primary:hover {
      background: radial-gradient(circle at top, #f97373, #9f1239 90%);
    }

    .footer-line {
      margin-top: 1rem;
      font-size: 0.72rem;
      text-align: center;
      color: var(--cc-text-soft);
    }

    .footer-line span {
      color: var(--cc-accent-soft);
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 40;
    }

    .modal-hidden {
      display: none;
    }

    .modal-box {
      width: min(420px, 92vw);
      border-radius: 1.4rem;
      border: 1px solid var(--cc-border);
      background: radial-gradient(circle at top, #020617, #02081b 65%);
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.9);
      padding: 1.2rem 1.15rem 1.3rem;
      display: flex;
      flex-direction: column;
      gap: 0.7rem;
    }

    .modal-title {
      font-size: 1.02rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .modal-body {
      font-size: 0.86rem;
      color: var(--cc-text-soft);
      line-height: 1.4;
    }

    .modal-buttons {
      display: flex;
      flex-wrap: wrap;
      justify-content: flex-end;
      gap: 0.5rem;
      margin-top: 0.2rem;
    }
  </style>
</head>
<body>
  <header>
    <div class="title-line">
      SCARLET CRUSH — LANE STACKER · <span class="code">ARC-SC-001</span>
    </div>
    <div class="subtitle-line">
      <span class="subtitle-pill">CaveCode Arcade Planet</span>
      <span class="subtitle-pill">Scarlet-Crush Line</span>
      <span class="subtitle-pill">Falling Blocks · Lane Puzzle</span>
      <span class="subtitle-pill">Single-File Engine</span>
    </div>
  </header>

  <main>
    <section class="panel">
      <div class="tag-row">
        <span class="tag highlight">Level Track</span>
        <span class="tag">Lane Stacking</span>
        <span class="tag">Row Clears</span>
        <span class="tag">Score Multipliers</span>
        <span class="tag">Special Gems</span>
        <span class="tag">Sound & Pop</span>
      </div>

      <p class="level-blurb" id="level-blurb">
        Drop colored blocks into the seven lanes. Fill full-color rows to clear
        them and keep the stack from overflowing.
      </p>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Level</div>
          <div class="stat-value" id="stat-level">1</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Score</div>
          <div class="stat-value" id="stat-score">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Target</div>
          <div class="stat-value" id="stat-target">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Drops Left</div>
          <div class="stat-value" id="stat-moves">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Rows Cleared</div>
          <div class="stat-value" id="stat-rows">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Best Chain</div>
          <div class="stat-value" id="stat-chain">0</div>
        </div>
      </div>

      <div class="board-shell">
        <div class="board-header-line">
          <div class="board-title">Tap a lane to drop the next block.</div>
          <div class="board-subtitle">
            Make solid-color rows before the stack hits the top.
          </div>
        </div>

        <div class="board-meta-row">
          <div class="preview-pill">
            <span class="preview-label">Next Block</span>
            <div class="preview-cell">
              <div id="preview-tile" class="tile preview-tile empty"></div>
            </div>
          </div>
          <div class="preview-pill">
            <span class="preview-label">Chain</span>
            <div class="preview-cell">
              <span id="preview-chain" style="font-size: 0.78rem;">x1.0</span>
            </div>
          </div>
        </div>

        <div id="board" class="board" aria-label="Lane stack board"></div>

        <div class="lane-row" id="lane-row"></div>

        <div class="controls-row">
          <button class="btn-secondary" id="btn-restart">
            Restart Level
          </button>
          <button class="btn-primary" id="btn-next">
            Next Level
          </button>
        </div>

        <div class="board-footer">
          <div>
            Match full rows of a single color to clear them. Clearing multiple
            rows in one cascade builds a <strong>chain multiplier</strong>.
          </div>
          <div>
            Special gems:
            <strong>Row</strong> (striped) clears its row. 
            <strong>Bomb</strong> (boxed) blasts a 3×3 chunk.
          </div>
        </div>
      </div>

      <div class="footer-line">
        Forged in CaveCode Arcade Planet · <span>SageWire Syndicate</span>
      </div>
    </section>
  </main>

  <div id="result-modal" class="modal-backdrop modal-hidden">
    <div class="modal-box">
      <div class="modal-title" id="modal-title">Line Cleared</div>
      <div class="modal-body" id="modal-body">
        You reached the target score before the stack overflowed.
      </div>
      <div class="modal-buttons">
        <button class="btn-secondary" id="modal-restart">Restart</button>
        <button class="btn-primary" id="modal-next">Next Level</button>
      </div>
    </div>
  </div>

  <script>
    /*
      BLOCK 2 — TUNING KNOBS (EDITABLE)
      Rows, columns, level track, scoring, and special-spawn odds.
    */

    const ROWS = 12;
    const COLS = 7;

    const COLORS = [0, 1, 2, 3, 4]; // mapped in CSS as color-0..4

    const LEVELS = [
      {
        id: 1,
        name: "Warm-Up Stack",
        target: 900,
        moves: 18,
        colors: 4,
      },
      {
        id: 2,
        name: "Scarlet Lines",
        target: 2200,
        moves: 22,
        colors: 5,
      },
      {
        id: 3,
        name: "Overflow Brink",
        target: 4200,
        moves: 26,
        colors: 5,
      },
    ];

    const TILE_TYPES = {
      NORMAL: "normal",
      ROW: "row",
      BOMB: "bomb",
    };

    const SPECIAL_ODDS = {
      ROW: 0.08, // 8% chance
      BOMB: 0.04, // 4% chance
    };

    const BASE_POINTS_PER_TILE = 45;
    const CHAIN_STEP = 0.35; // x1.0, x1.35, x1.7, ...

    /*
      BLOCK 3 — LAYOUT WIRING
      Grabs DOM nodes, draws board grid & lane buttons.
    */

    const boardEl = document.getElementById("board");
    const laneRowEl = document.getElementById("lane-row");

    const levelBlurbEl = document.getElementById("level-blurb");
    const statLevelEl = document.getElementById("stat-level");
    const statScoreEl = document.getElementById("stat-score");
    const statTargetEl = document.getElementById("stat-target");
    const statMovesEl = document.getElementById("stat-moves");
    const statRowsEl = document.getElementById("stat-rows");
    const statChainEl = document.getElementById("stat-chain");

    const previewTileEl = document.getElementById("preview-tile");
    const previewChainEl = document.getElementById("preview-chain");

    const btnRestartEl = document.getElementById("btn-restart");
    const btnNextEl = document.getElementById("btn-next");

    const modalEl = document.getElementById("result-modal");
    const modalTitleEl = document.getElementById("modal-title");
    const modalBodyEl = document.getElementById("modal-body");
    const modalRestartEl = document.getElementById("modal-restart");
    const modalNextEl = document.getElementById("modal-next");

    // Build lane buttons
    for (let c = 0; c < COLS; c++) {
      const btn = document.createElement("button");
      btn.className = "lane-btn";
      btn.textContent = c + 1;
      btn.addEventListener("click", () => handleLaneClick(c));
      laneRowEl.appendChild(btn);
    }

    /*
      BLOCK 4 — GAME ENGINE
      Board state, drop logic, row clears, specials, scoring, sound, modals.
    */

    let board = [];
    let currentLevelIndex = 0;
    let score = 0;
    let movesLeft = 0;
    let rowsCleared = 0;
    let bestChain = 0;
    let specialsSeen = 0;
    let currentTile = null;
    let gameOver = false;

    function makeEmptyBoard() {
      board = Array.from({ length: ROWS }, () =>
        Array.from({ length: COLS }, () => null)
      );
    }

    function randomInt(maxExclusive) {
      return Math.floor(Math.random() * maxExclusive);
    }

    function spawnTileSpec(level) {
      const colorPool = COLORS.slice(0, level.colors);
      const color = colorPool[randomInt(colorPool.length)];

      const roll = Math.random();
      let type = TILE_TYPES.NORMAL;
      if (roll < SPECIAL_ODDS.BOMB) {
        type = TILE_TYPES.BOMB;
      } else if (roll < SPECIAL_ODDS.BOMB + SPECIAL_ODDS.ROW) {
        type = TILE_TYPES.ROW;
      }

      if (type !== TILE_TYPES.NORMAL) {
        specialsSeen++;
      }

      return { color, type };
    }

    function setStatus(text) {
      levelBlurbEl.textContent = text;
    }

    function updateStats() {
      const lvl = LEVELS[currentLevelIndex];
      statLevelEl.textContent = lvl.id;
      statScoreEl.textContent = score.toString();
      statTargetEl.textContent = lvl.target.toString();
      statMovesEl.textContent = movesLeft.toString();
      statRowsEl.textContent = rowsCleared.toString();
      statChainEl.textContent = bestChain.toString();
    }

    function renderBoard(highlightSet) {
      boardEl.innerHTML = "";
      const highlight =
        highlightSet || new Set(); /* keys are "r:c" strings */

      for (let r = 0; r < ROWS; r++) {
        for (let c = 0; c < COLS; c++) {
          const cell = board[r][c];
          const div = document.createElement("div");
          div.className = "tile";
          if (!cell) {
            div.classList.add("empty");
          } else {
            div.classList.add("color-" + cell.color);
            if (cell.type !== TILE_TYPES.NORMAL) {
              div.classList.add("type-" + cell.type);
            }
            const key = r + ":" + c;
            if (highlight.has(key)) {
              div.classList.add("clearing");
            }
          }
          boardEl.appendChild(div);
        }
      }
    }

    function updatePreview() {
      if (!currentTile) {
        previewTileEl.className = "tile preview-tile empty";
        return;
      }
      previewTileEl.className = "tile preview-tile color-" + currentTile.color;
      if (currentTile.type !== TILE_TYPES.NORMAL) {
        previewTileEl.classList.add("type-" + currentTile.type);
      }
    }

    function updateChainPreview(multiplier) {
      previewChainEl.textContent = "x" + multiplier.toFixed(1);
    }

    function findDropRow(col) {
      for (let r = ROWS - 1; r >= 0; r--) {
        if (!board[r][col]) {
          return r;
        }
      }
      return -1; // full column
    }

    function handleLaneClick(col) {
      if (gameOver || !currentTile) {
        return;
      }

      const row = findDropRow(col);
      if (row === -1) {
        Sound.fail();
        endLevel(
          false,
          "That lane is full. The stack overflowed on that drop."
        );
        return;
      }

      const levelCfg = LEVELS[currentLevelIndex];

      board[row][col] = {
        color: currentTile.color,
        type: currentTile.type,
      };
      movesLeft--;
      Sound.drop();

      resolveAfterDrop(levelCfg);
    }

    function resolveAfterDrop(levelCfg) {
      let chain = 0;

      function loop() {
        const rowsToClear = findUniformRows();
        if (rowsToClear.length === 0) {
          if (chain > 0) {
            bestChain = Math.max(bestChain, chain);
          }
          updateStats();
          updateChainPreview(1.0);
          checkEndConditions(levelCfg);
          if (!gameOver) {
            currentTile = spawnTileSpec(levelCfg);
            updatePreview();
            renderBoard();
          }
          return;
        }

        chain++;
        const chainMultiplier = 1 + (chain - 1) * CHAIN_STEP;
        updateChainPreview(chainMultiplier);

        const clearSet = computeClearSet(rowsToClear);
        rowsCleared += rowsToClear.length;

        renderBoard(clearSet);
        Sound.match();

        setTimeout(() => {
          applyClearSet(clearSet);
          collapseBoard();

          const tilesCleared = clearSet.size;
          const delta = Math.round(
            tilesCleared * BASE_POINTS_PER_TILE * chainMultiplier
          );
          score += delta;

          renderBoard();
          updateStats();

          // Continue chaining
          setTimeout(loop, 60);
        }, 180);
      }

      loop();
    }

    function findUniformRows() {
      const rowsList = [];
      for (let r = 0; r < ROWS; r++) {
        let firstColor = null;
        let allSame = true;
        for (let c = 0; c < COLS; c++) {
          const cell = board[r][c];
          if (!cell) {
            allSame = false;
            break;
          }
          if (firstColor === null) {
            firstColor = cell.color;
          } else if (cell.color !== firstColor) {
            allSame = false;
            break;
          }
        }
        if (allSame && firstColor !== null) {
          rowsList.push(r);
        }
      }
      return rowsList;
    }

    function computeClearSet(rows) {
      const set = new Set();

      function add(r, c) {
        if (r < 0 || r >= ROWS || c < 0 || c >= COLS) return;
        if (board[r][c]) {
          set.add(r + ":" + c);
        }
      }

      rows.forEach((r) => {
        for (let c = 0; c < COLS; c++) {
          const cell = board[r][c];
          if (!cell) continue;
          add(r, c);

          if (cell.type === TILE_TYPES.BOMB) {
            for (let dr = -1; dr <= 1; dr++) {
              for (let dc = -1; dc <= 1; dc++) {
                add(r + dr, c + dc);
              }
            }
          } else if (cell.type === TILE_TYPES.ROW) {
            for (let cc = 0; cc < COLS; cc++) {
              add(r, cc);
            }
          }
        }
      });

      return set;
    }

    function applyClearSet(set) {
      set.forEach((key) => {
        const [r, c] = key.split(":").map(Number);
        board[r][c] = null;
      });
    }

    function collapseBoard() {
      for (let c = 0; c < COLS; c++) {
        let writeRow = ROWS - 1;
        for (let r = ROWS - 1; r >= 0; r--) {
          const cell = board[r][c];
          if (cell) {
            if (writeRow !== r) {
              board[writeRow][c] = cell;
              board[r][c] = null;
            }
            writeRow--;
          }
        }
      }
    }

    function checkEndConditions(levelCfg) {
      if (score >= levelCfg.target) {
        Sound.levelUp();
        endLevel(
          true,
          `You reached ${score} points. Target was ${levelCfg.target}.`
        );
        return;
      }

      if (movesLeft <= 0) {
        Sound.fail();
        endLevel(
          false,
          `You ran out of drops with ${score}/${levelCfg.target} points.`
        );
      }
    }

    function endLevel(win, message) {
      gameOver = true;
      showModal(win, message);
    }

    function showModal(win, message) {
      modalTitleEl.textContent = win ? "Line Cleared" : "Stack Overflow";
      modalBodyEl.textContent = message;
      modalNextEl.style.display = win ? "inline-flex" : "none";
      modalEl.classList.remove("modal-hidden");
    }

    function hideModal() {
      modalEl.classList.add("modal-hidden");
    }

    btnRestartEl.addEventListener("click", () => {
      startLevel(currentLevelIndex);
    });

    btnNextEl.addEventListener("click", () => {
      const next =
        currentLevelIndex + 1 < LEVELS.length ? currentLevelIndex + 1 : 0;
      startLevel(next);
    });

    modalRestartEl.addEventListener("click", () => {
      hideModal();
      startLevel(currentLevelIndex);
    });

    modalNextEl.addEventListener("click", () => {
      hideModal();
      const next =
        currentLevelIndex + 1 < LEVELS.length ? currentLevelIndex + 1 : 0;
      startLevel(next);
    });

    modalEl.addEventListener("click", (evt) => {
      if (evt.target === modalEl) {
        hideModal();
      }
    });

    /*
      Tiny synth beeps for feedback. No external audio assets.
    */
    const Sound = (() => {
      let ctx = null;

      function getCtx() {
        if (!ctx) {
          const AC = window.AudioContext || window.webkitAudioContext;
          if (!AC) return null;
          ctx = new AC();
        }
        return ctx;
      }

      function blip(freq, duration, gainPeak) {
        const ac = getCtx();
        if (!ac) return;
        const osc = ac.createOscillator();
        const gain = ac.createGain();
        osc.type = "sine";
        osc.frequency.value = freq;
        osc.connect(gain);
        gain.connect(ac.destination);
        const now = ac.currentTime;
        gain.gain.setValueAtTime(0.0001, now);
        gain.gain.linearRampToValueAtTime(gainPeak, now + 0.01);
        gain.gain.exponentialRampToValueAtTime(
          0.0001,
          now + (duration || 0.1)
        );
        osc.start(now);
        osc.stop(now + (duration || 0.1) + 0.04);
      }

      return {
        drop() {
          blip(220, 0.07, 0.22);
        },
        match() {
          blip(520, 0.09, 0.28);
        },
        fail() {
          blip(130, 0.28, 0.3);
        },
        levelUp() {
          blip(660, 0.09, 0.24);
          setTimeout(() => blip(880, 0.14, 0.26), 120);
        },
      };
    })();

    /*
      BLOCK 5 — BOOTSTRAP
      Start on Level 1, seed the first tile.
    */

    function startLevel(index) {
      currentLevelIndex = index;
      const cfg = LEVELS[index];

      makeEmptyBoard();
      score = 0;
      movesLeft = cfg.moves;
      rowsCleared = 0;
      bestChain = 0;
      specialsSeen = 0;
      gameOver = false;

      setStatus(
        `Level ${cfg.id} — ${cfg.name}. Reach ${cfg.target} points in ${cfg.moves} drops.`
      );

      currentTile = spawnTileSpec(cfg);
      updatePreview();
      updateChainPreview(1.0);
      updateStats();
      renderBoard();
    }

    // kick things off
    startLevel(0);
  </script>
</body>
</html>
